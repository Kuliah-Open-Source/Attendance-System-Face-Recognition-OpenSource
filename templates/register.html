<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Wajah Baru - Attendance System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        #video { width: 100%; max-width: 480px; border-radius: 10px; }
        .preview-container { position: relative; display: inline-block; }
        .capture-btn { background: linear-gradient(45deg, #28a745, #20c997); }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-arrow-left"></i> Kembali ke Dashboard
            </a>
            <span class="navbar-text">
                <i class="fas fa-user-plus"></i> Registrasi Wajah
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header text-center">
                        <h4><i class="fas fa-camera"></i> Daftarkan Wajah Baru</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nama Karyawan:</label>
                                    <input type="text" class="form-control" id="employeeName" placeholder="Masukkan nama lengkap">
                                </div>
                                
                                <div class="text-center">
                                    <div class="preview-container">
                                        <video id="video" autoplay></video>
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn capture-btn btn-lg text-white" onclick="capturePhoto()">
                                            <i class="fas fa-camera"></i> Ambil Foto
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Preview Foto:</label>
                                    <div id="photoPreview" class="border rounded p-3 text-center" style="min-height: 300px;">
                                        <div class="text-muted mt-5">
                                            <i class="fas fa-image fa-3x"></i>
                                            <p class="mt-2">Foto akan muncul di sini</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-grid">
                                    <button class="btn btn-primary btn-lg" onclick="registerFace()" disabled id="registerBtn">
                                        <i class="fas fa-save"></i> Daftarkan Wajah
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-body">
                        <h6><i class="fas fa-info-circle"></i> Petunjuk:</h6>
                        <ul class="mb-0">
                            <li>Pastikan wajah terlihat jelas dan tidak tertutup</li>
                            <li>Posisikan wajah di tengah kamera</li>
                            <li>Hindari pencahayaan yang terlalu terang atau gelap</li>
                            <li>Jangan menggunakan kacamata hitam atau masker</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let video = document.getElementById('video');
        let canvas = document.createElement('canvas');
        let ctx = canvas.getContext('2d');
        let capturedImage = null;

        // Start camera with better error handling
        async function startCamera() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Camera API tidak didukung');
                }

                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                };

                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play();
                };
                
            } catch (err) {
                console.error('Camera error:', err);
                let errorMsg = 'Tidak dapat mengakses kamera';
                
                if (err.name === 'NotAllowedError') {
                    errorMsg = 'Akses kamera ditolak. Silakan izinkan akses kamera.';
                } else if (err.name === 'NotFoundError') {
                    errorMsg = 'Kamera tidak ditemukan.';
                }
                
                alert('Error: ' + errorMsg);
            }
        }

        // Start camera on page load
        startCamera();

        function capturePhoto() {
            let name = document.getElementById('employeeName').value.trim();
            if (!name) {
                alert('Silakan masukkan nama karyawan terlebih dahulu');
                return;
            }

            if (!video.srcObject) {
                alert('Kamera tidak aktif. Silakan refresh halaman.');
                return;
            }

            if (video.videoWidth === 0 || video.videoHeight === 0) {
                alert('Video belum siap. Tunggu sebentar.');
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            capturedImage = canvas.toDataURL('image/jpeg', 0.8);
            
            // Show preview
            document.getElementById('photoPreview').innerHTML = 
                `<img src="${capturedImage}" class="img-fluid rounded" style="max-height: 300px;">`;
            
            document.getElementById('registerBtn').disabled = false;
        }

        function registerFace() {
            let name = document.getElementById('employeeName').value.trim();
            
            if (!name || !capturedImage) {
                alert('Silakan masukkan nama dan ambil foto terlebih dahulu');
                return;
            }

            document.getElementById('registerBtn').disabled = true;
            document.getElementById('registerBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mendaftarkan...';

            fetch('/api/register_face', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    name: name,
                    image: capturedImage 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ ' + data.message);
                    // Reset form
                    document.getElementById('employeeName').value = '';
                    document.getElementById('photoPreview').innerHTML = 
                        `<div class="text-muted mt-5">
                            <i class="fas fa-image fa-3x"></i>
                            <p class="mt-2">Foto akan muncul di sini</p>
                        </div>`;
                    capturedImage = null;
                } else {
                    alert('❌ Error: ' + data.message);
                }
                
                document.getElementById('registerBtn').disabled = false;
                document.getElementById('registerBtn').innerHTML = '<i class="fas fa-save"></i> Daftarkan Wajah';
            })
            .catch(err => {
                alert('Error: Gagal mendaftarkan wajah');
                document.getElementById('registerBtn').disabled = false;
                document.getElementById('registerBtn').innerHTML = '<i class="fas fa-save"></i> Daftarkan Wajah';
            });
        }
    </script>
</body>
</html>