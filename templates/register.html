<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Wajah Baru - Attendance System</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/effects.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/text-fixes.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Animated Background Bubbles -->
    <div class="bubble-container">
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
    </div>

    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6d/Polteksi.svg/1072px-Polteksi.svg.png" alt="Polteksi Logo" height="30" class="me-2">
                <i class="fas fa-arrow-left"></i> Kembali ke Dashboard
            </a>
            <span class="navbar-text">
                <i class="fas fa-user-plus"></i> Registrasi Wajah
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card slide-in-up">
                    <div class="card-header text-center">
                        <h4><i class="fas fa-camera pulse"></i> Daftarkan Wajah Baru</h4>
                        <p class="mb-0 mt-2">Pastikan wajah terlihat jelas dan pencahayaan cukup</p>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Nama Karyawan:</label>
                                    <input type="text" class="form-control" id="employeeName" placeholder="Masukkan nama lengkap" style="border-radius: 15px; padding: 12px 20px; border: 2px solid #fee2e2;">
                                </div>
                                
                                <div class="text-center">
                                    <div class="video-container">
                                        <video id="video" autoplay style="max-width: 100%; height: auto;"></video>
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn btn-scan btn-lg" onclick="capturePhoto()">
                                            <i class="fas fa-camera"></i> Ambil Foto
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Preview Foto:</label>
                                    <div id="photoPreview" class="border rounded-4 p-4 text-center" style="min-height: 350px; background: linear-gradient(135deg, #fef2f2, #ffffff); border: 2px dashed #dc2626 !important;">
                                        <div class="text-muted mt-5">
                                            <i class="fas fa-image fa-4x mb-3" style="color: #dc2626; opacity: 0.3;"></i>
                                            <h5>Foto akan muncul di sini</h5>
                                            <p>Ambil foto dengan kamera untuk melihat preview</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-grid">
                                    <button class="btn btn-primary btn-lg" onclick="registerFace()" disabled id="registerBtn" style="border-radius: 15px; padding: 15px;">
                                        <i class="fas fa-save"></i> Daftarkan Wajah
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4 slide-in-up" style="animation-delay: 0.3s">
                    <div class="card-body">
                        <h6><i class="fas fa-lightbulb" style="color: #dc2626;"></i> Tips untuk Hasil Terbaik:</h6>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li class="mb-2"><i class="fas fa-check-circle text-success"></i> Wajah terlihat jelas dan tidak tertutup</li>
                                    <li class="mb-2"><i class="fas fa-check-circle text-success"></i> Posisi wajah tegak lurus ke kamera</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li class="mb-2"><i class="fas fa-check-circle text-success"></i> Pencahayaan cukup terang</li>
                                    <li class="mb-2"><i class="fas fa-check-circle text-success"></i> Jangan gunakan kacamata hitam atau masker</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/premium-effects.js') }}"></script>
    <script>
        let video = document.getElementById('video');
        let canvas = document.createElement('canvas');
        let ctx = canvas.getContext('2d');
        let capturedImage = null;

        // Start camera with better error handling
        async function startCamera() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Camera API tidak didukung');
                }

                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                };

                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play();
                };
                
            } catch (err) {
                console.error('Camera error:', err);
                let errorMsg = 'Tidak dapat mengakses kamera';
                
                if (err.name === 'NotAllowedError') {
                    errorMsg = 'Akses kamera ditolak. Silakan izinkan akses kamera.';
                } else if (err.name === 'NotFoundError') {
                    errorMsg = 'Kamera tidak ditemukan.';
                }
                
                alert('Error: ' + errorMsg);
            }
        }

        // Start camera on page load
        startCamera();

        function capturePhoto() {
            let name = document.getElementById('employeeName').value.trim();
            if (!name) {
                alert('Silakan masukkan nama karyawan terlebih dahulu');
                return;
            }

            if (!video.srcObject) {
                alert('Kamera tidak aktif. Silakan refresh halaman.');
                return;
            }

            if (video.videoWidth === 0 || video.videoHeight === 0) {
                alert('Video belum siap. Tunggu sebentar.');
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            capturedImage = canvas.toDataURL('image/jpeg', 0.8);
            
            // Show preview
            document.getElementById('photoPreview').innerHTML = 
                `<img src="${capturedImage}" class="img-fluid rounded" style="max-height: 300px;">`;
            
            document.getElementById('registerBtn').disabled = false;
        }

        function registerFace() {
            let name = document.getElementById('employeeName').value.trim();
            
            if (!name || !capturedImage) {
                alert('Silakan masukkan nama dan ambil foto terlebih dahulu');
                return;
            }

            document.getElementById('registerBtn').disabled = true;
            document.getElementById('registerBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mendaftarkan...';

            fetch('/api/register_face', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    name: name,
                    image: capturedImage 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ ' + data.message);
                    // Reset form
                    document.getElementById('employeeName').value = '';
                    document.getElementById('photoPreview').innerHTML = 
                        `<div class="text-muted mt-5">
                            <i class="fas fa-image fa-3x"></i>
                            <p class="mt-2">Foto akan muncul di sini</p>
                        </div>`;
                    capturedImage = null;
                } else {
                    alert('❌ Error: ' + data.message);
                }
                
                document.getElementById('registerBtn').disabled = false;
                document.getElementById('registerBtn').innerHTML = '<i class="fas fa-save"></i> Daftarkan Wajah';
            })
            .catch(err => {
                alert('Error: Gagal mendaftarkan wajah');
                document.getElementById('registerBtn').disabled = false;
                document.getElementById('registerBtn').innerHTML = '<i class="fas fa-save"></i> Daftarkan Wajah';
            });
        }
    </script>
</body>
</html>